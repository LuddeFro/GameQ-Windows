import java.awt.AWTException;
import java.awt.Dimension;
import java.awt.Image;
import java.awt.MenuItem;
import java.awt.PopupMenu;
import java.awt.SystemTray;
import java.awt.Toolkit;
import java.awt.TrayIcon;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.io.IOException;

import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JTextField;

public class Main {
	
	public static ConnectionHandler connectionsHandler;
	public static DataModel dataHandler;
	public static JFrame frame;
	public static boolean bolRegging;
	public static JTextField txtEmail;
	public static JTextField txtPassword;
	public static JTextField txtSecretQ;
	public static JTextField txtSecret;
	public static JButton btnRegging;
	public static JButton btnLogin;
	public static final int frameWidth = 500;
	public static final int frameHeight = 300;
	public static TrayIcon trayIcon;
	public static MenuItem logItem;
    public static MenuItem toggleItem;
    
    public static final int middleXOffset = 10;
    public static final int fieldWidth = 200;
    public static final int fieldYOffset = 20;
    public static final int fieldHeight = 25;
    public static final int bonusFieldYOffset = fieldYOffset*2*3/4 + fieldHeight;
    public static final int buttonWidth = 120;
    public static final int buttonHeight = 30;
    public static final int buttonYOffset = fieldHeight*2 + fieldYOffset*3*3/4;
    
	public static void main(String args[]) {
		connectionsHandler = new ConnectionHandler();
		dataHandler = new DataModel();
		// setup agent program
		trayIcon = null;
		if (SystemTray.isSupported()) {
			final SystemTray tray = SystemTray.getSystemTray();
			Image trayImage = Toolkit.getDefaultToolkit().getImage(Main.class.getResource("/res/Qwhite.png")); 
			
			ActionListener logListener = new ActionListener() {
	             public void actionPerformed(ActionEvent e) {
	            	 System.out.println("pressed login/logout");
	                 if (dataHandler.getBolIsLoggedIn()) {
	                	 connectionsHandler.postLogout();
	                	 setupWindow();
	                	 setDisconnected();
	                 } else {
	                	 setupWindow();
	                 }
	             }
	         };
	         
	    
	         
	         ActionListener toggleListener = new ActionListener() {
	             public void actionPerformed(ActionEvent e) {
	            	 System.out.println("pressed toggle");
	                 toggle();
	             }
	         };
	         
	         MouseListener iconListener = new MouseListener() {
	             public void mouseCLicked(MouseEvent e) {
	            	 System.out.println("pressed icon");
	                 if (dataHandler.getBolIsLoggedIn()) {
	                	 toggle();
	                 } else {
	                	 setupWindow();
	                 }
	             }
	         };
	         
	         ActionListener quitListener = new ActionListener() {
	             public void actionPerformed(ActionEvent e) {
	            	 System.out.println("pressed quit");
	            	 if (dataHandler.getBolIsLoggedIn()) {
	            		 connectionsHandler.postLogout();
	            	 }
	            	 try {
						dataHandler.save();
					} catch (IOException e1) {
						e1.printStackTrace();
					} finally {
						tray.remove(trayIcon);
						System.exit(0);
					}
	             }
	         };	 
	         
	         /*
	         ActionListener listener = new ActionListener() {
	             public void actionPerformed(ActionEvent e) {
	                 
	             }
	         };*/
	         
	         
	         PopupMenu popup = new PopupMenu(); 
	         
	         logItem = new MenuItem();
	         toggleItem = new MenuItem();
	         MenuItem quitItem = new MenuItem();
	         
	         logItem.addActionListener(logListener);
	         toggleItem.addActionListener(toggleListener);
	         quitItem.addActionListener(quitListener);
	         
	         toggleItem.setLabel("Resume queue monitoring");
	         logItem.setLabel("Sign in / Sign up");
	         quitItem.setLabel("Quit");
	         
	         toggleItem.setEnabled(false);
	         
	         popup.add(toggleItem);
	         popup.add(logItem);
	         popup.add(quitItem);
	         
	         
	         
	         
	         // construct a TrayIcon
	         trayIcon = new TrayIcon(trayImage, "GameQ", popup);
	         // set the TrayIcon properties
	         trayIcon.addMouseListener(iconListener);
	         // ...
	         // add the tray image
	         try {
	             tray.add(trayIcon);
	         } catch (AWTException e) {
	             System.err.println(e);
	         }
		} else {
			//some kind of error handling
			//system tray is not supported
			//TODO
			
		}
		
	}
	
	public static void setupWindow() {
		bolRegging = false;
		if (frame == null) {
			frame = new JFrame("GameQ");
		}
		
		
		ActionListener loginListener = new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                Main.attemptLogin();
            }
        };
        
        KeyListener keyListen = new KeyListener() {
        	@Override
            public void keyPressed(KeyEvent e) { 
            	if (e.getKeyChar() == KeyEvent.VK_ENTER) {
            		System.out.println("pressed Enter");
            		attemptLogin();
            	}
            }

			@Override
			public void keyReleased(KeyEvent e) {
				
			}

			@Override
			public void keyTyped(KeyEvent e) {
				
			}
        };
        frame.addKeyListener(keyListen);
        
        ActionListener registerListener = new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                if (bolRegging) {
                	if (txtSecret == null || txtSecretQ == null) {
                		return;
                	} else {
                		txtSecret.setVisible(false);
                		txtSecretQ.setVisible(false);
                		btnRegging.setBounds(frameWidth/2-(fieldWidth/2+middleXOffset)-buttonWidth/2, bonusFieldYOffset, buttonWidth, buttonHeight);
                		btnLogin.setBounds(frameWidth/2 + middleXOffset +(fieldWidth/2 - buttonWidth/2), bonusFieldYOffset, buttonWidth, buttonHeight);
                		btnRegging.setText("Join GameQ");
                		btnLogin.setText("Sign In");
                		
                	}
                } else {
                	if (txtSecret == null || txtSecretQ == null) {
                		return;
                	} else {
                		txtSecret.setVisible(true);
                		txtSecretQ.setVisible(true);
                		btnRegging.setBounds(frameWidth/2-(fieldWidth/2+middleXOffset)-buttonWidth/2, buttonYOffset, buttonWidth, buttonHeight);
                		btnLogin.setBounds(frameWidth/2 + middleXOffset +(fieldWidth/2 - buttonWidth/2), buttonYOffset, buttonWidth, buttonHeight);
                		btnRegging.setText("Cancel");
                		btnLogin.setText("Join Now");
                	}
                }
                bolRegging = !bolRegging;
            }
        };
        
        
		
		frame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
		frame.setIconImage(Toolkit.getDefaultToolkit().getImage(Main.class.getResource("/res/Qwhite.png")));
		frame.setResizable(false);
		frame.setSize(frameWidth, frameHeight);
		Dimension dim = Toolkit.getDefaultToolkit().getScreenSize();
		frame.setLocation(dim.width/2-frame.getSize().width/2, dim.height/2-frame.getSize().height/2);
		frame.setLayout(null);
		
		// add components
		// frame.getContentPane().add(empyLabel, BorderLayout.CENTER);
		
		btnLogin = new JButton();
		btnLogin.setText("Sign In");
		btnLogin.addActionListener(loginListener);
		
		btnRegging = new JButton();
		btnRegging.setText("Join GameQ");
		btnRegging.addActionListener(registerListener);
		
		txtEmail = new JTextField(30);
		txtPassword = new JTextField(30);
		txtSecretQ = new JTextField(30);
		txtSecret = new JTextField(30);
		
		TextPrompt promptEmail = new TextPrompt("Email", txtEmail);
		promptEmail.changeAlpha(0.5f);
		TextPrompt promptPassword = new TextPrompt("Password", txtPassword);
		promptPassword.changeAlpha(0.5f);
		TextPrompt promptSecretQ = new TextPrompt("Secret Question/Hint", txtSecretQ);
		promptSecretQ.changeAlpha(0.5f);
		TextPrompt promptSecret = new TextPrompt("Secret Answer", txtSecret);
		promptSecret.changeAlpha(0.5f);
		
		frame.getContentPane().add(txtEmail);
		frame.getContentPane().add(txtPassword);
		frame.getContentPane().add(txtSecret);
		frame.getContentPane().add(txtSecretQ);
		frame.getContentPane().add(btnLogin);
		frame.getContentPane().add(btnRegging);
		
		
		
		txtEmail.setBounds(frameWidth/2-(fieldWidth+middleXOffset), fieldYOffset, fieldWidth, fieldHeight);
		txtPassword.setBounds(frameWidth/2+middleXOffset, fieldYOffset, fieldWidth, fieldHeight);
		txtSecret.setBounds(frameWidth/2+middleXOffset, bonusFieldYOffset, fieldWidth, fieldHeight);
		txtSecretQ.setBounds(frameWidth/2-(fieldWidth+middleXOffset), bonusFieldYOffset, fieldWidth, fieldHeight);
		btnRegging.setBounds(frameWidth/2-(fieldWidth/2+middleXOffset)-buttonWidth/2, bonusFieldYOffset, buttonWidth, buttonHeight);
		btnLogin.setBounds(frameWidth/2 + middleXOffset +(fieldWidth/2 - buttonWidth/2), bonusFieldYOffset, buttonWidth, buttonHeight);
		
		txtSecret.setVisible(false);
		txtSecretQ.setVisible(false);
		
		btnLogin.addKeyListener(keyListen);
		btnRegging.addKeyListener(keyListen);
		txtSecretQ.addKeyListener(keyListen);
		txtSecret.addKeyListener(keyListen);
		txtEmail.addKeyListener(keyListen);
		txtPassword.addKeyListener(keyListen);
		
		//frame.pack();
		frame.setVisible(true);
		
	}
	
	public static void connect() {
		//TODO
	}
	
	public static void disconnect() {
		//TODO
	}
	
	public static void setConnected() {
		//TODO
	}
	public static void setDisconnected() {
		//TODO
	}
	
	public static void logout() {
		//TODO
	}
	public static void attemptLogin() {
		//TODO
	}
	public static void attemptRegister() {
		//TODO
	}
	private static void toggle() {
		//TODO
	}
	private static void toggleOn() {
		//TODO
	}
	private static void toggleOff() {
		//TODO
	}
}